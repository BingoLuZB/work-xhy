;;"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _XWmM6a3Obackground=_interopRequireDefault(require("../IRjSr6J6runtime/XWmM6a3Obackground"));var _WOklGuAdSprite=_interopRequireDefault(require("../QycaeVLxbase/WOklGuAdSprite"));var _JowmRIGiDataStore=_interopRequireDefault(require("../QycaeVLxbase/JowmRIGiDataStore"));var _wenIOsErquestions=require("../orsfnpj1data/wenIOsErquestions");var _kxrMwBNKindex=require("../X5gHYJsdutils/kxrMwBNKindex");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _instanceof(a,b){if(b!=null&&typeof Symbol!=="undefined"&&b[Symbol.hasInstance]){return b[Symbol.hasInstance](a)}else{return a instanceof b}}function _classCallCheck(a,b){if(!_instanceof(a,b)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(a,b){for(var i=0;i<b.length;i++){var c=b[i];c.enumerable=c.enumerable||false;c.configurable=true;if("value"in c)c.writable=true;Object.defineProperty(a,c.key,c)}}function _createClass(a,b,c){if(b)_defineProperties(a.prototype,b);if(c)_defineProperties(a,c);return a}var screenWidth=window.innerWidth;var screenHeight=window.innerHeight;var ratio=750/screenWidth;var scale=750/screenWidth;var ResultScene=function(){function ResultScene(a){_classCallCheck(this,ResultScene);this.ctx=a;this.score=_JowmRIGiDataStore.default.getInstance().score;this.saveUserCloadStorage();this.loop()}_createClass(ResultScene,[{key:"loop",value:function loop(){this.background=new _XWmM6a3Obackground.default(this.ctx,scale);this.drawEle();if(this.ranking){this.background=new _XWmM6a3Obackground.default(this.ctx,scale);this.drawEle();_JowmRIGiDataStore.default.getInstance().ctx.drawImage(_JowmRIGiDataStore.default.getInstance().resultCanvas,0,0,screenWidth,screenHeight);_JowmRIGiDataStore.default.getInstance().ctx.drawImage(_JowmRIGiDataStore.default.getInstance().sharedCanvas,0,0,screenWidth,screenHeight)}else{_JowmRIGiDataStore.default.getInstance().ctx.drawImage(_JowmRIGiDataStore.default.getInstance().resultCanvas,0,0,screenWidth,screenHeight)}this.requestId=requestAnimationFrame(this.loop.bind(this))}},{key:"drawEle",value:function drawEle(){var a=_WOklGuAdSprite.default.getImage('title');var b=new _WOklGuAdSprite.default(a,(750-a.width)/2,40,a.width,a.height);b.draw(this.ctx);var c=_WOklGuAdSprite.default.getImage('result_bg');var d=new _WOklGuAdSprite.default(c,(750-c.width)/2,b.height+60,c.width,c.height);d.draw(this.ctx);this.ctx.fillStyle='#1b282c';this.ctx.font='30px Arial';this.ctx.fillText('你的分数',d.x+100,d.y+190);this.ctx.fillText('分',750-d.x-120,d.y+190);this.ctx.save();this.ctx.font='24px Arial';(0,_kxrMwBNKindex.drawText)(_wenIOsErquestions.remarks[this.score],d.x+100,d.y+240,d.width-200,this.ctx,ratio);this.ctx.fillStyle='#fff';this.ctx.font='76px Arial';this.ctx.fillText(this.score,750-d.x-300,d.y+170);this.ctx.save();this.rankImg=_WOklGuAdSprite.default.getImage('result_rank');this.rankSprite=new _WOklGuAdSprite.default(this.rankImg,(750-this.rankImg.width)/2,d.y+d.height+40,this.rankImg.width,this.rankImg.height);this.rankSprite.draw(this.ctx);this.reportImg=_WOklGuAdSprite.default.getImage('report_btn');this.reportSprite=new _WOklGuAdSprite.default(this.reportImg,(750-this.reportImg.width)/2,this.rankSprite.y+this.rankSprite.height+40,this.reportImg.width,this.reportImg.height);this.reportSprite.draw(this.ctx);this.bindEvent()}},{key:"messageSharecanvas",value:function messageSharecanvas(a,b){var c=wx.getOpenDataContext();c.postMessage({type:a||'friends',text:b});this.ranking=true}},{key:"bindEvent",value:function bindEvent(){var b=this;wx.offTouchStart();if(this.ranking){wx.onTouchStart(function(e){var x=e.touches[0].clientX,y=e.touches[0].clientY;var a=screenWidth/750;if(x>=80*a&&x<=180*a&&y>=1120*a&&y<=1220*a){b.ranking=false;setTimeout(function(){cancelAnimationFrame(b.requestId)},20)}});return}wx.onTouchStart(function(e){var x=e.touches[0].clientX*ratio,y=e.touches[0].clientY*ratio;if(x>=b.rankSprite.x&&x<=b.rankSprite.x+b.rankSprite.width&&y>=b.rankSprite.y&&y<=b.rankSprite.y+b.rankSprite.height){b.messageSharecanvas();b.loop();wx.offTouchStart()}else if(x>=b.reportSprite.x&&x<=b.reportSprite.x+b.reportSprite.width&&y>=b.reportSprite.y&&y<=b.reportSprite.y+b.reportSprite.height){b.report()}})}},{key:"report",value:function report(){var e=this;var f=wx.createCanvas();var g=f.getContext('2d');f.width=screenWidth*ratio;f.height=screenHeight*ratio;g.scale(ratio,ratio);g.scale(screenWidth/750,screenWidth/750);new _XWmM6a3Obackground.default(g,scale);var h=_WOklGuAdSprite.default.getImage('title');var i=new _WOklGuAdSprite.default(h,(750-h.width)/2,40,h.width,h.height);i.draw(g);var j=_WOklGuAdSprite.default.getImage('result_bg');var k=new _WOklGuAdSprite.default(j,(750-j.width)/2,i.height+60,j.width,j.height);k.draw(g);g.fillStyle='#1b282c';g.font='30px Arial';g.fillText('你的分数',k.x+100,k.y+190);g.fillText('分',750-k.x-120,k.y+190);g.save();g.font='24px Arial';(0,_kxrMwBNKindex.drawText)(_wenIOsErquestions.remarks[this.score],k.x+100,k.y+240,k.width-200,this.ctx,ratio);g.fillStyle='#fff';g.font='76px Arial';g.fillText(this.score,750-k.x-300,k.y+170);g.save();var l=_WOklGuAdSprite.default.getImage('report_tip');var m=new _WOklGuAdSprite.default(l,(750-l.width)/2,k.y+k.height+40,l.width,l.height);m.draw(g);f.toTempFilePath({x:0,y:0,width:screenWidth*ratio,height:screenHeight*ratio,destWidth:screenWidth*ratio,destHeight:screenHeight*ratio,success:function success(d){wx.getSetting({success:function success(b){var c=b.authSetting;if(c['scope.writePhotosAlbum']===false){wx.showModal({title:'提示',content:'您拒绝了保存到相册到权限，请手动到设置页面打开授权开关',showCancel:false,confirmText:'知道了',success:function success(a){}})}else{wx.saveImageToPhotosAlbum({filePath:d.tempFilePath,success:function success(a){console.log(a)},fail:function fail(a){console.log(a.errMsg);if(a.errMsg.indexOf('deny')){}}})}}})}})}},{key:"saveUserCloadStorage",value:function saveUserCloadStorage(){var c=''+this.score;wx.setUserCloudStorage({KVDataList:[{key:'score',value:c}],success:function success(a){console.log(a);var b=wx.getOpenDataContext();b.postMessage({type:'updateMaxScore'})},fail:function fail(a){console.log(a)}})}}]);return ResultScene}();exports.default=ResultScene;;